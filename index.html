<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Relatório de Fiscalização</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
  h1 { text-align: center; }
  #fotoInput { margin-bottom: 10px; }
  #fotoList { list-style: none; padding: 0; }
  #fotoList li { margin: 5px 0; padding: 5px; background: #fff; border: 1px solid #ccc; cursor: grab; display: flex; align-items: center; }
  #fotoList li.dragging { opacity: 0.5; }
  #fotoList img { max-height: 80px; margin-right: 10px; }
  .botao { margin: 5px; padding: 5px 10px; cursor: pointer; }
  #layoutChoice { margin: 10px 0; }
</style>
</head>
<body>

<h1>Relatório de Fiscalização</h1>

<input type="file" id="fotoInput" multiple accept="image/*">
<ul id="fotoList"></ul>

<div id="layoutChoice">
  <label>Fotos por página:</label>
  <select id="fotosPorPagina">
    <option value="1">1 foto por página</option>
    <option value="2" selected>2 fotos por página</option>
  </select>
</div>

<button class="botao" id="gerarPDF">Gerar PDF</button>

<!-- Biblioteca jsPDF local -->
<script src="jspdf.umd.min.js"></script>

<script>
const { jsPDF } = window.jspdf;
const fotoInput = document.getElementById('fotoInput');
const fotoList = document.getElementById('fotoList');
let fotosArray = [];

fotoInput.addEventListener('change', async (e) => {
  const files = Array.from(e.target.files);
  for (let file of files) {
    const compressed = await compressImage(file, 1); // ≤1MB
    const src = URL.createObjectURL(compressed);
    fotosArray.push({ file: compressed, src });
    renderFotos();
  }
  fotoInput.value = '';
});

function renderFotos() {
  fotoList.innerHTML = '';
  fotosArray.forEach((foto, index) => {
    const li = document.createElement('li');
    li.draggable = true;
    li.dataset.index = index;
    li.innerHTML = `<img src="${foto.src}"><span>Foto ${index+1}</span>`;
    fotoList.appendChild(li);
  });
}

// Drag & drop
let draggingIndex = null;
fotoList.addEventListener('dragstart', e => {
  draggingIndex = e.target.dataset.index;
  e.target.classList.add('dragging');
});
fotoList.addEventListener('dragend', e => e.target.classList.remove('dragging'));
fotoList.addEventListener('dragover', e => e.preventDefault());
fotoList.addEventListener('drop', e => {
  e.preventDefault();
  const target = e.target.closest('li');
  if (!target || target.dataset.index === draggingIndex) return;
  const from = draggingIndex;
  const to = target.dataset.index;
  const movedItem = fotosArray.splice(from,1)[0];
  fotosArray.splice(to,0,movedItem);
  renderFotos();
});

// Compressão para ≤ 1 MB
function compressImage(file, maxMB) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img,0,0);
        let quality = 0.9;
        let dataUrl = canvas.toDataURL('image/jpeg', quality);
        while (dataUrl.length/1024/1024 > maxMB && quality > 0.1) {
          quality -= 0.05;
          dataUrl = canvas.toDataURL('image/jpeg', quality);
        }
        fetch(dataUrl).then(r => r.blob()).then(blob => resolve(blob));
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

// Gerar PDF
document.getElementById('gerarPDF').addEventListener('click', async () => {
  const pdf = new jsPDF({unit:'pt', format:'a4'});
  const fotosPorPagina = parseInt(document.getElementById('fotosPorPagina').value);
  const pageWidth = pdf.internal.pageSize.getWidth() - 40;
  const pageHeight = pdf.internal.pageSize.getHeight() - 60;
  const margin = 20;
  let y = margin;
  let fotoCount = 0;
  for (let i=0;i<fotosArray.length;i++){
    const file = fotosArray[i].file;
    const img = await fileToImage(file);
    const ratio = Math.min(pageWidth, pageHeight/(fotosPorPagina)) / Math.max(img.width,img.height);
    const w = img.width * ratio;
    const h = img.height * ratio;
    if (fotoCount>0 && fotoCount%fotosPorPagina===0) {
      pdf.addPage();
      y = margin;
    }
    pdf.addImage(img, 'JPEG', (pageWidth-w)/2+margin, y, w, h);
    y += h + 10;
    fotoCount++;
  }
  // Rodapé
  const pageCount = pdf.getNumberOfPages();
  for (let p=1;p<=pageCount;p++){
    pdf.setPage(p);
    pdf.setFontSize(10);
    pdf.text('Fotos da data da fiscalização', pageWidth/2 + margin, pageHeight + 30, {align:'center'});
    pdf.text(`Página ${p} de ${pageCount}`, pageWidth - margin, pageHeight + 30, {align:'right'});
  }
  pdf.save('relatorio.pdf');
});

function fileToImage(file){
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.src = URL.createObjectURL(file);
  });
}
</script>

</body>
</html>
